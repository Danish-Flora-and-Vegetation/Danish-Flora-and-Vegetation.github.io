---
title: "Most common species in natural areas of Denmark"
output:
  bookdown::html_document2:
    code_folding: hide
    fig_caption: true
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, error = FALSE, warning = FALSE, cache = T)
library(tidyverse)
library(data.table)
library(janitor)
library(DT)

FinalDataset <- readRDS("MostCommon/Final_dataset.rds") |> 
  mutate_if(is.numeric, ~10*(.x/max(.x, na.rm = T)))

Home <- getwd()

mostFrequentSpecies <- readRDS("MostCommon/FrekWithElenberg.rds") |> ungroup() |> dplyr::select(-plot, -year) |> dplyr::group_by_all() |> summarise(Number = n()) |> arrange(desc(Number)) |> ungroup() |>  mutate_at(.vars = vars(m:ratio_n_r),  ~10*(.x/max(.x, na.rm = T)))|> mutate_at(.vars = vars(m:ratio_n_r), round) |> pivot_longer(cols = c(m:ratio_n_r), names_to = "Ellenberg") |> dplyr::filter(!is.na(value)) |> ungroup() |> group_by(Ellenberg, value) |> dplyr::filter(Number == max(Number)) |> arrange(Ellenberg, value)

Danish_Names <- readRDS("MostCommon/Final_dataset.rds") |> 
  dplyr::select(NavnDansk, canonicalName, species)

Totals <- readRDS("MostCommon/Final_dataset.rds") |> dplyr::select(canonicalName, species, starts_with("eiv_eres_")) |> mutate_if(is.numeric, round) |> dplyr::distinct() |> pivot_longer(cols = starts_with("eiv_eres_"), names_to = "Ellenberg") |> mutate(Ellenberg = stringr::str_remove_all(Ellenberg,"eiv_eres_")) |> dplyr::filter(!is.na(value)) |> ungroup() |> group_by(Ellenberg) |> summarise(Total = n()) 

PropSpeciesPerValue <- readRDS("MostCommon/Final_dataset.rds")  |> dplyr::select(canonicalName, species, starts_with("eiv_eres_")) |> ungroup() |> dplyr::distinct() |> dplyr::group_by_all() |> ungroup() |> mutate_at(.vars = vars(eiv_eres_m:eiv_eres_ratio_n_r), round) |> pivot_longer(cols = c(eiv_eres_m:eiv_eres_ratio_n_r), names_to = "Ellenberg") |> mutate(Ellenberg = stringr::str_remove_all(Ellenberg,"eiv_eres_")) |> dplyr::filter(!is.na(value)) |> ungroup() |> group_by(Ellenberg, value) |> summarise(n_species = n()) |> full_join(Totals) |> ungroup() |> mutate(percentage = round(100*n_species/Total,2)) |> 
  dplyr::select(-n_species, -Total) |> 
  full_join(mostFrequentSpecies) |> 
  left_join(Danish_Names) |> dplyr::select(Ellenberg, value, percentage, NavnDansk, species)

PropSpeciesPerValue_Ready <- PropSpeciesPerValue |> dplyr::filter(!is.na(species))

PropSpeciesPerValue_Missing <- PropSpeciesPerValue |> dplyr::filter(is.na(species)) |> 
  dplyr::select(-NavnDansk, -species)

set.seed(2023)

To_Fill <- PropSpeciesPerValue <- readRDS("MostCommon/Final_dataset.rds")  |> dplyr::select(canonicalName, species, starts_with("eiv_eres_")) |> ungroup() |> dplyr::distinct() |> dplyr::group_by_all() |> ungroup() |> mutate_at(.vars = vars(eiv_eres_m:eiv_eres_ratio_n_r), round) |> pivot_longer(cols = c(eiv_eres_m:eiv_eres_ratio_n_r), names_to = "Ellenberg") |> mutate(Ellenberg = stringr::str_remove_all(Ellenberg,"eiv_eres_")) |> dplyr::filter(!is.na(value)) |> 
  ungroup() |> 
  dplyr::right_join(PropSpeciesPerValue_Missing) |> 
  dplyr::select("Ellenberg", "value", "percentage", "species") |> 
  group_by(Ellenberg, value) |> 
  slice_sample(n = 1) |> 
  ungroup()

PropSpeciesPerValue <- bind_rows(PropSpeciesPerValue_Ready, To_Fill) |> arrange(Ellenberg, value)

setwd("MostCommon/")

Artlist <- data.table::fread("artsliste.csv") %>% 
  as.data.frame() %>% 
  mutate_if(is.character, ~iconv(.x, from="Windows-1252", to="UTF-8"))

library(readr)

frekvens2 <- read_csv("alledata-frekvens2.txt") %>%
  mutate_if(is.character, ~iconv(.x, from="Windows-1252", to="UTF-8")) %>% 
  janitor::clean_names() %>%
  as_tibble()

frekvens2$species <- iconv(frekvens2$specieslist,from="Windows-1252", to="UTF-8") %>% str_split(",")

frekvens2 <- frekvens2 %>%
  dplyr::select(-specieslist) %>%
  unnest(species) %>%
  mutate(species = str_trim(species, side = "both"),
         species = str_remove_all(species, "\\}"),
         site = str_remove_all(site, "\\{"),
         species = as.numeric(species)) %>%
  rename(ArtID = species) %>%
  left_join(Artlist) %>%
  dplyr::select("site", "plot", "year", "ArtID", "NavnDansk",
                "LatArt", "LatFam", "LatOrd", "LatKla",
                "LatDivision", "LatRige") %>% 
  dplyr::filter(LatDivision %in% c("Anthocerophyta", "Bangiophyta", 
"Charophyta", "Chlorophyta", "Cyanophyta", "Magnoliophyta", "Pinophyta", "Pteridophyta", "Xanthophyta"
))  %>% dplyr::mutate(LatArt = str_replace_all(LatArt,"\xeb", "e"),
                      NavnDansk = str_replace_all(NavnDansk,"\\<f8\\>", "\u00f8"),
                      NavnDansk = str_replace_all(NavnDansk,"\\<e6\\>", "\u00e6"),
                      NavnDansk = str_replace_all(NavnDansk,"\\<e5\\>", "\u00e")) %>% 
  dplyr::filter(year <= lubridate::year(Sys.Date()))

PerSpeciesPlot <- frekvens2 %>%
  dplyr::select("site", "plot", "LatArt", "LatFam", "NavnDansk") %>%
  distinct() %>%
  group_by(LatArt, LatFam, NavnDansk) %>%
  summarise(Occurrences = n()) %>%
  arrange(desc(Occurrences)) %>% 
  rename(Family = LatFam,
         Species = LatArt,
         Danish_name = NavnDansk) %>% 
  tibble::rowid_to_column(var = "Ranking")

PerFamily <- frekvens2 %>%
  dplyr::select(LatArt, LatFam) %>%
  distinct() %>%
  group_by(LatFam) %>%
  summarise(Species_number = n()) %>%
  arrange(desc(Species_number)) %>%
  rename(Family = LatFam)

PerGenus <- frekvens2

PerGenus$Genus <- str_split(frekvens2$LatArt," ", simplify = T)[,1] %>% str_trim() 

PerGenus <- PerGenus %>%
  dplyr::select(LatArt, Genus) %>%
  distinct() %>%
  group_by(Genus) %>%
  summarise(Species_number = n()) %>%
  arrange(desc(Species_number))

PerSpeciesPlotlyAll <- PerSpeciesPlot %>% 
  ungroup() %>% 
  dplyr::select(Species, Family, Occurrences) %>% 
  mutate(Family = "All") %>% 
  slice_max(order_by = Occurrences, n = 100)

TopFamilies <- PerFamily %>% 
  ungroup() %>% 
  slice_max(Species_number, n = 10) %>% 
  pull(Family)

PerSpeciesFamiliesPlotly <- PerSpeciesPlot %>% 
  ungroup() %>% 
  dplyr::select(Species, Family, Occurrences) %>% 
  dplyr::filter(Family %in% TopFamilies) %>% 
 group_split(Family) %>% 
  purrr::map(~slice_max(.x, order_by = Occurrences, n = 100)) %>% 
  purrr::reduce(bind_rows) %>% 
  bind_rows(PerSpeciesPlotlyAll)

FamNames <- PerSpeciesFamiliesPlotly$Family %>% unique() %>% sort()


df <- PerSpeciesFamiliesPlotly
```

# Introduction

In this exercise we are characterizing the most common species found in the Danish monitoring program NOVANA (Nationale OvervÃ¥gningsprogram for Vand og Natur). The data observations includes `r prettyNum(nrow(frekvens2),big.mark = ".", decimal.mark = ",")` samples in `r prettyNum(length(unique(frekvens2$site)),big.mark = ".", decimal.mark = ",")` sites, and `r prettyNum(length(unique(frekvens2$plot)),big.mark = ".", decimal.mark = ",")` plots sampled from `r min(frekvens2$year)`, till `r max(frekvens2$year)`. This includes `r prettyNum(length(unique(frekvens2$LatArt)),big.mark = ".", decimal.mark = ",")` that have been sampled at least once.

## Number of plots per species

If we take into account how many plots a species has been detected at leas once, you can see in table \@ref(tab:SpeciesPerPlot) the list of the species in Denmark ordered by the number of occurrences it has, note that using the search bar you can search for only one family. You can also download this list or any other table within this document with the buttons above, as well as set the number of species to be shown, you can see 100 most common species in red letters and yellow background.

```{r SpeciesPerPlot, results='asis'}

datatable(PerSpeciesPlot, extensions = 'Buttons',
                    caption = cat('<table style="width:100%">',paste0("<caption>", "(#tab:SpeciesPerPlot)",
                      "Species ordered by family and number of occurrences.", "</caption>"),"</table>", sep ="\n"),
            filter = "top",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All")))) %>%
  formatStyle("Species",'Ranking',
    color = styleInterval(100, c('white', 'white')),
    backgroundColor = styleInterval(100, c('green', 'gray'))
  )

```

## Observations within families

You can also explore the following interactive plot in figure \@ref(fig:HCplot), you can choose to show all families, or click on any of the ones which has one of the 500 most common species to get an overview of their composition, and check the number of occurrence per species, by hovering over the plot.

You can play with the controls where you can download the images or the data within the graph.

```{r HCplot, results='asis', fig.cap="Number of occurrences per family, and species within those families."}
library(highcharter)
PerSpeciesHCAll2 <- PerSpeciesPlot %>% 
  ungroup() %>% 
  dplyr::select(Species, Family, Occurrences) %>% 
  mutate(All = "All") %>% 
  slice_max(order_by = Occurrences, n = 500)


lvl_opts <-  list(
  list(
    level = 1,
    borderWidth = 0,
    borderColor = "transparent",
    dataLabels = list(
      enabled = TRUE,
      align = "left",
      verticalAlign = "top",
      style = list(
        fontSize = "12px", 
        textOutline = FALSE,
        color = "white",
        fontWeight = "normal"
      )
    )
  ),
  list(
    level = 2,
    borderWidth = 0,
    borderColor = "transparent",
    colorVariation = list(key = "brightness", to = 0.250),
    dataLabels = list(enabled = FALSE),
    style = list(
      fontSize = "8px",
      textOutline = FALSE, 
      color = "white", 
      fontWeight = "normal"
    )
  )
)

dout <- data_to_hierarchical(PerSpeciesHCAll2, c(Family, Species), Occurrences)

hchart(dout, type = "treemap",
       # levelIsConstant = FALSE,
       allowDrillToNode = TRUE,
       levels = lvl_opts,
       tooltip = list(valueDecimals = FALSE))  %>%
  hc_exporting(
    enabled = TRUE, # always enabled
    filename = "custom-file-name"
  )

cat("<figure>", paste0("(#fig:HCplot)"),
                      "</figure>", sep ="\n")

```

Also in the following figure \@ref(fig:ThePlot), you can check the distribution of the species occurrences abundance, note the distribution of rare and common species, you can zoom in and out, and hover over the bars to identify the species. You can also download the image using the camera icon

```{r ThePlot, fig.cap= "Number of occurrences by species with a focus on rarity and commonality"}
library(plotly)

plot_ly() %>%
  add_trace(data = df[df$Family == FamNames[1],] %>%
              mutate(Species = fct_reorder(Species, desc(Occurrences))),
            x = ~Species,
            y = ~Occurrences,
            type = 'bar',
            name = FamNames[1],
            visible = T,
            inherit = F) %>%
  add_trace(data = df[df$Family == FamNames[2],]%>%
              mutate(Species = fct_reorder(Species, desc(Occurrences))),
            x = ~Species,
            y = ~Occurrences,
            type = 'bar',
            name = FamNames[2],
            visible = F,
            inherit = F) %>%
  add_trace(data = df[df$Family == FamNames[3],] %>%
              mutate(Species = fct_reorder(Species, desc(Occurrences))),
            x = ~Species,
            y = ~Occurrences,
            type = 'bar',
            name = FamNames[3],
            visible = F,
            inherit = F) %>%
    add_trace(data = df[df$Family == FamNames[4],] %>%
              mutate(Species = fct_reorder(Species, desc(Occurrences))),
            x = ~Species,
            y = ~Occurrences,
            type = 'bar',
            name = FamNames[4],
            visible = F,
            inherit = F) %>%
    add_trace(data = df[df$Family == FamNames[5],] %>%
              mutate(Species = fct_reorder(Species, desc(Occurrences))),
            x = ~Species,
            y = ~Occurrences,
            type = 'bar',
            name = FamNames[5],
            visible = F,
            inherit = F) %>%
    add_trace(data = df[df$Family == FamNames[6],] %>%
              mutate(Species = fct_reorder(Species, desc(Occurrences))),
            x = ~Species,
            y = ~Occurrences,
            type = 'bar',
            name = FamNames[6],
            visible = F,
            inherit = F) %>%
    add_trace(data = df[df$Family == FamNames[7],] %>%
              mutate(Species = fct_reorder(Species, desc(Occurrences))),
            x = ~Species,
            y = ~Occurrences,
            type = 'bar',
            name = FamNames[7],
            visible = F,
            inherit = F) %>%
    add_trace(data = df[df$Family == FamNames[8],] %>%
              mutate(Species = fct_reorder(Species, desc(Occurrences))),
            x = ~Species,
            y = ~Occurrences,
            type = 'bar',
            name = FamNames[8],
            visible = F,
            inherit = F) %>%
    add_trace(data = df[df$Family == FamNames[9],] %>%
              mutate(Species = fct_reorder(Species, desc(Occurrences))),
            x = ~Species,
            y = ~Occurrences,
            type = 'bar',
            name = FamNames[9],
            visible = F,
            inherit = F) %>%
    add_trace(data = df[df$Family == FamNames[10],] %>%
              mutate(Species = fct_reorder(Species, desc(Occurrences))),
            x = ~Species,
            y = ~Occurrences,
            type = 'bar',
            name = FamNames[10],
            visible = F,
            inherit = F) %>%
    add_trace(data = df[df$Family == FamNames[11],] %>%
              mutate(Species = fct_reorder(Species, desc(Occurrences))),
            x = ~Species,
            y = ~Occurrences,
            type = 'bar',
            name = FamNames[11],
            visible = F,
            inherit = F) %>%
  layout(
    xaxis = list(
      nticks = 0,
      showticklabels=F
    ),
    updatemenus = list(
      list(y = .7,
           buttons = list(
             list(method = "update",
                  args = list(list(visible = c(T, F, F, F, F, F, F, F, F, F, F)),
                              list(title = FamNames[1])),
                  label = FamNames[1]),
             list(method = "update",
                  args = list(list(visible = c(F, T, F, F, F, F, F, F, F, F, F)),
                              list(title = FamNames[2])),
                  label = FamNames[2]),
             list(method = "update",
                  args = list(list(visible = c(F, F, T, F, F, F, F, F, F, F, F)),
                              list(title = FamNames[3])),
                  label = FamNames[3]),
             list(method = "update",
                  args = list(list(visible = c(F, F, F, T, F, F, F, F, F, F, F)),
                              list(title = FamNames[4])),
                  label = FamNames[4]),
             list(method = "update",
                  args = list(list(visible = c(F, F, F, F, T, F, F, F, F, F, F)),
                              list(title = FamNames[5])),
                  label = FamNames[5]),
             list(method = "update",
                  args = list(list(visible = c(F, F, F, F, F, T, F, F, F, F, F)),
                              list(title = FamNames[6])),
                  label = FamNames[6]),
             list(method = "update",
                  args = list(list(visible = c(F, F, F, F, F, F, T, F, F, F, F)),
                              list(title = FamNames[7])),
                  label = FamNames[7]),
             list(method = "update",
                  args = list(list(visible = c(F, F, F, F, F, F, F, T, F, F, F)),
                              list(title = FamNames[8])),
                  label = FamNames[8]),
             list(method = "update",
                  args = list(list(visible = c(F, F, F, F, F, F, F, F, T, F, F)),
                              list(title = FamNames[9])),
                  label = FamNames[9]),
             list(method = "update",
                  args = list(list(visible = c(F, F, F, F, F, F, F, F, F, T, F)),
                              list(title = FamNames[10])),
                  label = FamNames[10]),
             list(method = "update",
                  args = list(list(visible = c(F, F, F, F, F, F, F, F, F, F, T)),
                              list(title = FamNames[11])),
                  label = FamNames[11])
           )))
  )

```

## Number of species per family

We can see the number of species per family in a decreasing order in table \@ref(tab:SpeciesPerFamily)

```{r SpeciesPerFamily, results='asis'}
## number of species per family


datatable(PerFamily, extensions = 'Buttons',
          caption = cat('<table style="width:100%">',paste0("<caption>", "(#tab:SpeciesPerFamily)", " Families ordered by the number of species they have.", "</caption>", "</caption>"),"</table>", sep ="\n"),
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

Again, in the figure \@ref(fig:PerFamily), play around with the graph, to check the distribution of the species number, zoom in and out, and explore the families with most and least amount of species

```{r PerFamily, fig.cap= "Number of species per family"}
plotly::ggplotly(ggplot(PerFamily, aes(x = reorder(Family, desc(Species_number)), y = Species_number)) + geom_col() + theme_bw() + labs(x = "Family", y = "Speceis Number") + theme(axis.text.x = element_blank(), axis.ticks =element_blank()))
```



## Number of species per Genus

The number of species per genus can be seen in table \@ref(tab:SpeciesPerGenus):

```{r SpeciesPerGenus, results='asis'}

datatable(PerGenus, extensions = 'Buttons',
          caption = cat('<table style="width:100%">',paste0("<caption>", "(#tab:SpeciesPerGenus)", "Genera ordered by the number of species they have.", "</caption>"),"</table>", sep ="\n"),
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```


# Ellenberg values

Next week you will be learning about Ellenberg indicator values. For now you can explore the frequency of species with the different values in Denmark as seen in figure \@ref(fig:EllenbergHist)

```{r EllenbergHist, fig.cap= "Histogram of Ellenberg values for different species in Denmark"}
G <- FinalDataset |> dplyr::select(species, dplyr::starts_with("eiv_")) |> dplyr::distinct()  |> tidyr::pivot_longer(dplyr::starts_with("eiv_"), names_to = "Ellenberg") |> dplyr::mutate(Ellenberg = stringr::str_remove_all(Ellenberg, "eiv_eres_")) |> dplyr::mutate(Ellenberg = stringr::str_to_upper(Ellenberg)) |> 
  dplyr::filter(!is.na(value)) |> ggplot(aes(x = value)) + facet_wrap(~Ellenberg, scales = 'free_y') +
  geom_histogram(binwidth = function(x) 2 * IQR(x) / (length(x)^(1/3)))

plotly::ggplotly(G)
```

You can see how for certain indicators such as L and R this values are heavily skewed.

In table \@ref(tab:EllenbergTable) you can see the percentage of species that are within an ellenberg value as well as the most common species having that value. So as an example 30.13 percent of all species in Denmark have an M indicator value of 4 and the most common species with that value is *Carex arenaria* (sand-star)

```{r EllenbergTable}
datatable(PropSpeciesPerValue, extensions = 'Buttons',
          caption = cat('<table style="width:100%">',paste0("<caption>", "(#tab:EllenbergTable)", "Percentage of species in Denmark with an ellenberg value. Also shows the most common species with that value as an example.", "</caption>", "</caption>"),"</table>", sep ="\n"),
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```


```{r}
setwd(Home)
```
